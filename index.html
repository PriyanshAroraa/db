<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Performance Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #007acc;
            padding-bottom: 20px;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .metric {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .metric h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            opacity: 0.9;
        }
        .metric .value {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
        }
        .charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .chart {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .refresh-btn {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .refresh-btn:hover {
            background: #005a9e;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Bot Performance Dashboard</h1>
            <p>Real-time monitoring of trading bot performance</p>
            <button class="refresh-btn" onclick="loadData()">üîÑ Refresh Data</button>
        </div>

        <div id="loading" class="loading">
            <h3>Loading bot performance data...</h3>
        </div>

        <div id="error" class="error" style="display: none;">
            <h4>Error loading data</h4>
            <p id="error-message"></p>
        </div>

        <div id="dashboard" style="display: none;">
            <div class="metrics" id="metrics">
                <!-- Metrics will be populated here -->
            </div>

            <div class="charts">
                <div class="chart">
                    <h3>üìä Bot Performance Comparison</h3>
                    <div id="performance-chart"></div>
                </div>

                <div class="chart">
                    <h3>üèÅ Races Entered</h3>
                    <div id="races-chart"></div>
                </div>

                <div class="chart">
                    <h3>üí∞ Balance Analysis</h3>
                    <div id="balance-chart"></div>
                </div>

                <div class="chart">
                    <h3>üìà Performance Efficiency</h3>
                    <div id="efficiency-chart"></div>
                </div>
            </div>

            <div class="chart">
                <h3>üìÖ Daily Performance Trends</h3>
                <div id="trends-chart"></div>
            </div>

            <div class="chart">
                <h3>üìã Detailed Bot Performance</h3>
                <div id="data-table"></div>
            </div>
        </div>
    </div>

    <script>
        const BOT_NAMES = {
            10111491: "Alba",
            10211493: "Eirean", 
            10411491: "Kernow",
            10711491: "Cymru",
            11011491: "Albion"
        };

        async function loadData() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const dashboard = document.getElementById('dashboard');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            dashboard.style.display = 'none';

            try {
                const response = await fetch('/api/bot-data');
                const result = await response.json();

                if (result.success) {
                    displayData(result.data);
                    loading.style.display = 'none';
                    dashboard.style.display = 'block';
                } else {
                    throw new Error(result.error);
                }
            } catch (err) {
                loading.style.display = 'none';
                error.style.display = 'block';
                document.getElementById('error-message').textContent = err.message;
            }
        }

        function displayData(data) {
            // Process data
            const overview = processOverviewData(data);
            
            // Display metrics
            displayMetrics(overview);
            
            // Create charts
            createPerformanceChart(overview);
            createRacesChart(overview);
            createBalanceChart(overview);
            createEfficiencyChart(overview);
            createTrendsChart(data.daily_pnl);
            createDataTable(overview);
        }

        function processOverviewData(data) {
            const overview = [];
            
            for (let user_id in BOT_NAMES) {
                const botName = BOT_NAMES[user_id];
                const totalPnl = data.total_pnl.find(d => d.user_id == user_id)?.total_pnl_IGGT || 0;
                const reserve = data.reserve_balance.find(d => d.user_id == user_id)?.reserve_balance_IGGT || 0;
                const inPlay = data.in_play_balance.find(d => d.user_id == user_id)?.in_play_balance_IGGT || 0;
                const races = data.races_entered.find(d => d.user_id == user_id)?.races_entered || 0;
                
                overview.push({
                    bot_name: botName,
                    user_id: parseInt(user_id),
                    total_pnl_IGGT: totalPnl,
                    reserve_balance_IGGT: reserve,
                    in_play_balance_IGGT: inPlay,
                    races_entered: races,
                    pnl_per_race: races > 0 ? totalPnl / races : 0
                });
            }
            
            return overview;
        }

        function displayMetrics(overview) {
            const totalPnl = overview.reduce((sum, bot) => sum + bot.total_pnl_IGGT, 0);
            const totalRaces = overview.reduce((sum, bot) => sum + bot.races_entered, 0);
            const totalReserve = overview.reduce((sum, bot) => sum + bot.reserve_balance_IGGT, 0);
            const totalInPlay = overview.reduce((sum, bot) => sum + bot.in_play_balance_IGGT, 0);

            document.getElementById('metrics').innerHTML = `
                <div class="metric">
                    <h3>Total P&L (IGGT)</h3>
                    <p class="value">${totalPnl.toLocaleString()}</p>
                </div>
                <div class="metric">
                    <h3>Total Races</h3>
                    <p class="value">${totalRaces.toLocaleString()}</p>
                </div>
                <div class="metric">
                    <h3>Total Reserve (IGGT)</h3>
                    <p class="value">${totalReserve.toLocaleString()}</p>
                </div>
                <div class="metric">
                    <h3>In-Play Exposure (IGGT)</h3>
                    <p class="value">${totalInPlay.toLocaleString()}</p>
                </div>
            `;
        }

        function createPerformanceChart(overview) {
            const trace = {
                x: overview.map(bot => bot.bot_name),
                y: overview.map(bot => bot.total_pnl_IGGT),
                type: 'bar',
                marker: {
                    color: overview.map(bot => bot.total_pnl_IGGT > 3000 ? '#4CAF50' : bot.total_pnl_IGGT > 2000 ? '#FF9800' : '#F44336')
                }
            };

            const layout = {
                title: 'Total P&L by Bot',
                xaxis: { title: 'Bot Name' },
                yaxis: { title: 'P&L (IGGT)' }
            };

            Plotly.newPlot('performance-chart', [trace], layout);
        }

        function createRacesChart(overview) {
            const trace = {
                x: overview.map(bot => bot.bot_name),
                y: overview.map(bot => bot.races_entered),
                type: 'bar',
                marker: { color: '#2196F3' }
            };

            const layout = {
                title: 'Total Races by Bot',
                xaxis: { title: 'Bot Name' },
                yaxis: { title: 'Number of Races' }
            };

            Plotly.newPlot('races-chart', [trace], layout);
        }

        function createBalanceChart(overview) {
            const trace1 = {
                x: overview.map(bot => bot.bot_name),
                y: overview.map(bot => bot.reserve_balance_IGGT),
                type: 'bar',
                name: 'Reserve Balance',
                marker: { color: '#81C784' }
            };

            const trace2 = {
                x: overview.map(bot => bot.bot_name),
                y: overview.map(bot => bot.in_play_balance_IGGT),
                type: 'bar',
                name: 'In-Play Balance',
                marker: { color: '#FFB74D' }
            };

            const layout = {
                title: 'Reserve vs In-Play Balances',
                xaxis: { title: 'Bot Name' },
                yaxis: { title: 'Balance (IGGT)' },
                barmode: 'group'
            };

            Plotly.newPlot('balance-chart', [trace1, trace2], layout);
        }

        function createEfficiencyChart(overview) {
            const trace = {
                x: overview.map(bot => bot.races_entered),
                y: overview.map(bot => bot.total_pnl_IGGT),
                mode: 'markers+text',
                text: overview.map(bot => bot.bot_name),
                textposition: 'top center',
                marker: {
                    size: overview.map(bot => Math.max(bot.pnl_per_race * 10, 20)),
                    color: overview.map(bot => bot.total_pnl_IGGT > 3000 ? '#4CAF50' : bot.total_pnl_IGGT > 2000 ? '#FF9800' : '#F44336'),
                    opacity: 0.7
                }
            };

            const layout = {
                title: 'P&L vs Races (Bubble Size = P&L per Race)',
                xaxis: { title: 'Total Races' },
                yaxis: { title: 'Total P&L (IGGT)' }
            };

            Plotly.newPlot('efficiency-chart', [trace], layout);
        }

        function createTrendsChart(dailyData) {
            if (!dailyData || dailyData.length === 0) return;

            const traces = [];
            const botNames = [...new Set(dailyData.map(d => BOT_NAMES[d.user_id]))];

            botNames.forEach(botName => {
                const botData = dailyData.filter(d => BOT_NAMES[d.user_id] === botName);
                traces.push({
                    x: botData.map(d => d.date),
                    y: botData.map(d => d.daily_pnl_IGGT),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: botName
                });
            });

            const layout = {
                title: 'Daily P&L Trends by Bot',
                xaxis: { title: 'Date' },
                yaxis: { title: 'Daily P&L (IGGT)' }
            };

            Plotly.newPlot('trends-chart', traces, layout);
        }

        function createDataTable(overview) {
            const table = `
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <thead>
                        <tr style="background-color: #f5f5f5;">
                            <th style="padding: 10px; border: 1px solid #ddd;">Bot Name</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">User ID</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Total P&L (IGGT)</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Reserve Balance (IGGT)</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">In-Play Balance (IGGT)</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Total Races</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Performance Rating</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${overview.map(bot => `
                            <tr>
                                <td style="padding: 10px; border: 1px solid #ddd;">${bot.bot_name}</td>
                                <td style="padding: 10px; border: 1px solid #ddd;">${bot.user_id}</td>
                                <td style="padding: 10px; border: 1px solid #ddd;">${bot.total_pnl_IGGT.toLocaleString()}</td>
                                <td style="padding: 10px; border: 1px solid #ddd;">${bot.reserve_balance_IGGT.toLocaleString()}</td>
                                <td style="padding: 10px; border: 1px solid #ddd;">${bot.in_play_balance_IGGT.toLocaleString()}</td>
                                <td style="padding: 10px; border: 1px solid #ddd;">${bot.races_entered}</td>
                                <td style="padding: 10px; border: 1px solid #ddd;">
                                    ${bot.total_pnl_IGGT > 3000 ? 'üü¢ Excellent' : 
                                      bot.total_pnl_IGGT > 2000 ? 'üü° Good' : 'üî¥ Needs Attention'}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('data-table').innerHTML = table;
        }

        // Load data on page load
        window.onload = loadData;

        // Auto-refresh every 5 minutes
        setInterval(loadData, 5 * 60 * 1000);
    </script>
</body>
</html>
